name: Scheduled Health Check

on:
  schedule:
    # ë§¤ 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC 0, 6, 12, 18ì‹œ)
    - cron: '0 */6 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Check Context App
        run: |
          echo "ðŸ” Checking Context App..."
          FAILED=0

          # Homepage
          HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "https://context.soundbluemusic.com/")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Context homepage returned HTTP $HTTP_CODE"
            FAILED=1
          else
            echo "âœ… Context homepage: HTTP 200"
          fi

          # Entry page (D1 query)
          HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "https://context.soundbluemusic.com/entry/annyeong")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Context entry page returned HTTP $HTTP_CODE"
            FAILED=1
          else
            echo "âœ… Context entry page: HTTP 200"
          fi

          # SSR content check
          HTML=$(curl -sL "https://context.soundbluemusic.com/entry/annyeong")
          if ! echo "$HTML" | grep -q 'ì•ˆë…•'; then
            echo "âŒ Context SSR content missing (D1 query failed)"
            FAILED=1
          else
            echo "âœ… Context SSR content present"
          fi

          if [ "$FAILED" -eq 1 ]; then
            echo "::error::Context App health check failed"
            exit 1
          fi

      - name: Check Permissive App
        run: |
          echo "ðŸ” Checking Permissive App..."
          FAILED=0

          # Homepage
          HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "https://permissive.soundbluemusic.com/")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Permissive homepage returned HTTP $HTTP_CODE"
            FAILED=1
          else
            echo "âœ… Permissive homepage: HTTP 200"
          fi

          # Library page
          HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "https://permissive.soundbluemusic.com/library/react")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Permissive library page returned HTTP $HTTP_CODE"
            FAILED=1
          else
            echo "âœ… Permissive library page: HTTP 200"
          fi

          if [ "$FAILED" -eq 1 ]; then
            echo "::error::Permissive App health check failed"
            exit 1
          fi

      - name: Check Roots App
        run: |
          echo "ðŸ” Checking Roots App..."
          FAILED=0

          # Homepage
          HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "https://roots.soundbluemusic.com/")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Roots homepage returned HTTP $HTTP_CODE"
            FAILED=1
          else
            echo "âœ… Roots homepage: HTTP 200"
          fi

          # Concept page
          HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "https://roots.soundbluemusic.com/concept/addition")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Roots concept page returned HTTP $HTTP_CODE"
            FAILED=1
          else
            echo "âœ… Roots concept page: HTTP 200"
          fi

          if [ "$FAILED" -eq 1 ]; then
            echo "::error::Roots App health check failed"
            exit 1
          fi

      - name: Check Response Times
        run: |
          echo "ðŸ” Checking response times..."

          for URL in \
            "https://context.soundbluemusic.com/" \
            "https://permissive.soundbluemusic.com/" \
            "https://roots.soundbluemusic.com/"
          do
            TIME=$(curl -sL -o /dev/null -w "%{time_total}" "$URL")
            TIME_MS=$(echo "$TIME * 1000" | bc | cut -d'.' -f1)

            if [ "$TIME_MS" -gt 3000 ]; then
              echo "âš ï¸ $URL: ${TIME_MS}ms (slow, >3s)"
            else
              echo "âœ… $URL: ${TIME_MS}ms"
            fi
          done

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "âœ¨ All health checks passed!"
          echo "Checked at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
