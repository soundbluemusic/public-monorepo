name: Deploy Context SSG to R2

on:
  push:
    branches: [main]
    paths:
      - 'data/context/**'
      - 'apps/context/**'
      - 'packages/**'
  workflow_dispatch:

concurrency:
  group: deploy-context-r2-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-sync:
    name: Build SSG & Deploy to R2
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build R2 SSG (33,672 entry pages)
        run: pnpm build:r2
        working-directory: apps/context
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Verify SSG HTML content (404 detection)
        working-directory: apps/context
        run: |
          echo "ğŸ” ë¹Œë“œëœ HTMLì—ì„œ 404 ì½˜í…ì¸  ê°ì§€ ê²€ì‚¬ ì¤‘..."

          # 404 íŒ¨í„´ ëª©ë¡
          NOT_FOUND_PATTERNS=(
            "ë‹¨ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            "Entry Not Found"
            "í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            "Page Not Found"
          )

          FAILED=0

          # ì˜ì–´ entry í˜ì´ì§€ ê²€ì‚¬
          echo "ğŸ“‚ ì˜ì–´ entry í˜ì´ì§€ ê²€ì‚¬..."
          for pattern in "${NOT_FOUND_PATTERNS[@]}"; do
            COUNT=$(grep -r "<title[^>]*>$pattern" build/client/entry/ 2>/dev/null | wc -l || echo "0")
            if [ "$COUNT" -gt 0 ]; then
              echo "âŒ ì˜ì–´ entry í˜ì´ì§€ì—ì„œ '$pattern' íŒ¨í„´ $COUNTê°œ ë°œê²¬"
              FAILED=$((FAILED + COUNT))
            fi
          done

          # í•œê¸€ entry í˜ì´ì§€ ê²€ì‚¬
          echo "ğŸ“‚ í•œê¸€ entry í˜ì´ì§€ ê²€ì‚¬..."
          for pattern in "${NOT_FOUND_PATTERNS[@]}"; do
            COUNT=$(grep -r "<title[^>]*>$pattern" build/client/ko/entry/ 2>/dev/null | wc -l || echo "0")
            if [ "$COUNT" -gt 0 ]; then
              echo "âŒ í•œê¸€ entry í˜ì´ì§€ì—ì„œ '$pattern' íŒ¨í„´ $COUNTê°œ ë°œê²¬"
              FAILED=$((FAILED + COUNT))
            fi
          done

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "âŒ ì´ $FAILEDê°œì˜ 404 ì½˜í…ì¸  ê°ì§€ë¨!"
            echo "   loaderì—ì„œ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ - params.locale ì‚¬ìš© ì—¬ë¶€ í™•ì¸ í•„ìš”"
            exit 1
          fi

          echo "âœ… ëª¨ë“  entry í˜ì´ì§€ ì½˜í…ì¸  ì •ìƒ (404 ì—†ìŒ)"

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for R2
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          acl = private
          EOF

      - name: Sync entry SSG HTML to R2
        working-directory: apps/context
        run: |
          echo "ğŸ“¤ Uploading English entries..."
          rclone sync build/client/entry r2:all-sites-static/public-monorepo/context/entry \
            --checksum --transfers 32 --checkers 32 --fast-list \
            --stats 10s --stats-one-line -v

          echo "ğŸ“¤ Uploading Korean entries..."
          rclone sync build/client/ko/entry r2:all-sites-static/public-monorepo/context/ko/entry \
            --checksum --transfers 32 --checkers 32 --fast-list \
            --stats 10s --stats-one-line -v

      - name: Wait for CDN propagation
        run: sleep 30

      - name: Verify SSG URLs (sample test)
        run: |
          echo "ğŸ” ì‚¬ì´íŠ¸ë§µ URL ìƒ˜í”Œ ê²€ì¦ ì¤‘..."

          # ì‚¬ì´íŠ¸ë§µì—ì„œ ì—”íŠ¸ë¦¬ URL ì¶”ì¶œ (ì˜ì–´ + í•œêµ­ì–´ ê° 50ê°œ)
          curl -s https://context.soundbluemusic.com/sitemap-entries.xml | \
            grep -oP '(?<=<loc>)[^<]+' | shuf -n 100 > /tmp/sample-urls.txt

          FAILED=0
          TESTED=0

          while IFS= read -r url; do
            TESTED=$((TESTED + 1))
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Cache-Control: no-cache" "$url")
            SSG_SOURCE=$(curl -s -I -H "Cache-Control: no-cache" "$url" | grep -i "x-ssg-source" | cut -d: -f2 | tr -d ' \r')

            if [ "$STATUS" != "200" ]; then
              echo "âŒ [$STATUS] $url"
              FAILED=$((FAILED + 1))
            elif [ "$SSG_SOURCE" != "r2" ]; then
              echo "âš ï¸ [SPA fallback] $url (X-SSG-Source: $SSG_SOURCE)"
              FAILED=$((FAILED + 1))
            fi
          done < /tmp/sample-urls.txt

          echo ""
          echo "ğŸ“Š ê²€ì¦ ê²°ê³¼: $TESTEDê°œ í…ŒìŠ¤íŠ¸, $FAILEDê°œ ì‹¤íŒ¨"

          if [ "$FAILED" -gt 0 ]; then
            echo "âŒ R2 SSG ì„œë¹™ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… ëª¨ë“  ìƒ˜í”Œ URLì´ R2ì—ì„œ ì •ìƒ ì„œë¹™ë©ë‹ˆë‹¤."

      - name: Summary
        run: |
          echo "âœ… R2 SSG ë°°í¬ ì™„ë£Œ"
          echo "   - ì˜ì–´ ì—”íŠ¸ë¦¬: /entry/*"
          echo "   - í•œêµ­ì–´ ì—”íŠ¸ë¦¬: /ko/entry/*"
          echo "   - ìƒ˜í”Œ ê²€ì¦: 100ê°œ URL í†µê³¼"
