name: Deploy Context SSG to R2

on:
  push:
    branches: [main]
    paths:
      - 'data/context/**'
      - 'apps/context/**'
      - 'packages/**'
  workflow_dispatch:

concurrency:
  group: deploy-context-r2-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-sync:
    name: Build SSG & Deploy to R2
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build R2 SSG (33,672 entry pages)
        run: pnpm build:r2
        working-directory: apps/context
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for R2
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          acl = private
          EOF

      - name: Sync entry SSG HTML to R2
        working-directory: apps/context
        run: |
          echo "üì§ Uploading English entries..."
          rclone sync build/client/entry r2:all-sites-static/public-monorepo/context/entry \
            --checksum --transfers 32 --checkers 32 --fast-list \
            --stats 10s --stats-one-line -v

          echo "üì§ Uploading Korean entries..."
          rclone sync build/client/ko/entry r2:all-sites-static/public-monorepo/context/ko/entry \
            --checksum --transfers 32 --checkers 32 --fast-list \
            --stats 10s --stats-one-line -v

      - name: Wait for CDN propagation
        run: sleep 30

      - name: Verify SSG URLs (sample test)
        run: |
          echo "üîç ÏÇ¨Ïù¥Ìä∏Îßµ URL ÏÉòÌîå Í≤ÄÏ¶ù Ï§ë..."

          # ÏÇ¨Ïù¥Ìä∏ÎßµÏóêÏÑú ÏóîÌä∏Î¶¨ URL Ï∂îÏ∂ú (ÏòÅÏñ¥ + ÌïúÍµ≠Ïñ¥ Í∞Å 50Í∞ú)
          curl -s https://context.soundbluemusic.com/sitemap-entries.xml | \
            grep -oP '(?<=<loc>)[^<]+' | shuf -n 100 > /tmp/sample-urls.txt

          FAILED=0
          TESTED=0

          while IFS= read -r url; do
            TESTED=$((TESTED + 1))
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Cache-Control: no-cache" "$url")
            SSG_SOURCE=$(curl -s -I -H "Cache-Control: no-cache" "$url" | grep -i "x-ssg-source" | cut -d: -f2 | tr -d ' \r')

            if [ "$STATUS" != "200" ]; then
              echo "‚ùå [$STATUS] $url"
              FAILED=$((FAILED + 1))
            elif [ "$SSG_SOURCE" != "r2" ]; then
              echo "‚ö†Ô∏è [SPA fallback] $url (X-SSG-Source: $SSG_SOURCE)"
              FAILED=$((FAILED + 1))
            fi
          done < /tmp/sample-urls.txt

          echo ""
          echo "üìä Í≤ÄÏ¶ù Í≤∞Í≥º: $TESTEDÍ∞ú ÌÖåÏä§Ìä∏, $FAILEDÍ∞ú Ïã§Ìå®"

          if [ "$FAILED" -gt 0 ]; then
            echo "‚ùå R2 SSG ÏÑúÎπôÏóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§!"
            exit 1
          fi

          echo "‚úÖ Î™®Îì† ÏÉòÌîå URLÏù¥ R2ÏóêÏÑú Ï†ïÏÉÅ ÏÑúÎπôÎê©ÎãàÎã§."

      - name: Summary
        run: |
          echo "‚úÖ R2 SSG Î∞∞Ìè¨ ÏôÑÎ£å"
          echo "   - ÏòÅÏñ¥ ÏóîÌä∏Î¶¨: /entry/*"
          echo "   - ÌïúÍµ≠Ïñ¥ ÏóîÌä∏Î¶¨: /ko/entry/*"
          echo "   - ÏÉòÌîå Í≤ÄÏ¶ù: 100Í∞ú URL ÌÜµÍ≥º"
