name: Delete Pages Projects

on:
  workflow_dispatch:

jobs:
  delete:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all deployments then destroy projects
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g cloudflare-bulk-delete

          echo "=== Step 1: Delete ALL ro0ts deployments ==="
          cf-bulk-delete delete pages ro0ts \
            --token "$CLOUDFLARE_API_TOKEN" \
            --account "$CLOUDFLARE_ACCOUNT_ID" \
            --yes || echo "ro0ts deployments deletion done"

          echo "=== Step 2: Delete ALL permissive deployments ==="
          cf-bulk-delete delete pages permissive \
            --token "$CLOUDFLARE_API_TOKEN" \
            --account "$CLOUDFLARE_ACCOUNT_ID" \
            --yes || echo "permissive deployments deletion done"

          echo "=== Step 3: Destroy ro0ts project ==="
          cf-bulk-delete destroy pages ro0ts \
            --token "$CLOUDFLARE_API_TOKEN" \
            --account "$CLOUDFLARE_ACCOUNT_ID" \
            --yes || echo "ro0ts project destruction done"

          echo "=== Step 4: Destroy permissive project ==="
          cf-bulk-delete destroy pages permissive \
            --token "$CLOUDFLARE_API_TOKEN" \
            --account "$CLOUDFLARE_ACCOUNT_ID" \
            --yes || echo "permissive project destruction done"

      - name: Verify deletion
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g cloudflare-bulk-delete
          echo "=== Remaining resources ==="
          cf-bulk-delete list --token "$CLOUDFLARE_API_TOKEN" --account "$CLOUDFLARE_ACCOUNT_ID"
