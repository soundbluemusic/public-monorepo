name: Delete Pages Projects

on:
  workflow_dispatch:

jobs:
  delete:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all ro0ts deployments and project
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Delete all deployments for ro0ts
          echo "Fetching ro0ts deployments..."
          DEPLOYMENTS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts/deployments?per_page=100" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq -r '.result[].id')

          for ID in $DEPLOYMENTS; do
            echo "Deleting deployment $ID..."
            curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts/deployments/${ID}?force=true" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"
          done

          # Delete the project
          echo "Deleting ro0ts project..."
          curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"

      - name: Delete all permissive (Pages) deployments and project
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Check if permissive Pages project exists
          EXISTS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq -r '.success')

          if [ "$EXISTS" = "true" ]; then
            # Delete all deployments for permissive
            echo "Fetching permissive deployments..."
            DEPLOYMENTS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive/deployments?per_page=100" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq -r '.result[].id')

            for ID in $DEPLOYMENTS; do
              echo "Deleting deployment $ID..."
              curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive/deployments/${ID}?force=true" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"
            done

            # Delete the project
            echo "Deleting permissive Pages project..."
            curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"
          else
            echo "permissive Pages project not found or already deleted"
          fi

      - name: Verify deletion
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Remaining Pages projects:"
          curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq '.result[].name'
