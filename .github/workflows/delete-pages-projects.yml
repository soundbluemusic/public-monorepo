name: Delete Pages Projects

on:
  workflow_dispatch:

jobs:
  delete:
    runs-on: ubuntu-latest
    steps:
      - name: Delete ro0ts Pages project with all deployments
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set +e

          echo "=== Checking ro0ts project ==="
          RESPONSE=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}")
          echo "$RESPONSE" | jq '.'

          echo "=== Fetching and deleting ro0ts deployments ==="
          PAGE=1
          while true; do
            RESPONSE=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts/deployments?per_page=25&page=${PAGE}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}")

            DEPLOYMENTS=$(echo "$RESPONSE" | jq -r '.result[]?.id // empty')

            if [ -z "$DEPLOYMENTS" ]; then
              echo "No more deployments on page $PAGE"
              break
            fi

            for ID in $DEPLOYMENTS; do
              echo "Deleting deployment $ID..."
              curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts/deployments/${ID}?force=true" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq '.success'
            done

            PAGE=$((PAGE + 1))
            if [ $PAGE -gt 20 ]; then
              echo "Reached max pages, breaking"
              break
            fi
          done

          echo "=== Deleting ro0ts project ==="
          curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/ro0ts" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq '.'

      - name: Delete permissive Pages project with all deployments
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set +e

          echo "=== Checking permissive project ==="
          RESPONSE=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}")
          echo "$RESPONSE" | jq '.success'

          echo "=== Fetching and deleting permissive deployments ==="
          PAGE=1
          while true; do
            RESPONSE=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive/deployments?per_page=25&page=${PAGE}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}")

            DEPLOYMENTS=$(echo "$RESPONSE" | jq -r '.result[]?.id // empty')

            if [ -z "$DEPLOYMENTS" ]; then
              echo "No more deployments on page $PAGE"
              break
            fi

            for ID in $DEPLOYMENTS; do
              echo "Deleting deployment $ID..."
              curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive/deployments/${ID}?force=true" \
                -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq '.success'
            done

            PAGE=$((PAGE + 1))
            if [ $PAGE -gt 20 ]; then
              echo "Reached max pages, breaking"
              break
            fi
          done

          echo "=== Deleting permissive project ==="
          curl -s -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/permissive" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq '.'

      - name: Verify deletion
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== Remaining Pages projects ==="
          curl -s "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" | jq '.result[].name'
