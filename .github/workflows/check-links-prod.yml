name: Production Link Check

on:
  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST) = ì¼ìš”ì¼ ìì • (UTC)
  schedule:
    - cron: '0 0 * * 0'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      urls:
        description: 'ê²€ì‚¬í•  URL (ì‰¼í‘œë¡œ êµ¬ë¶„, ë¹„ìš°ë©´ ëª¨ë“  ì•±)'
        required: false
        default: ''

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: link-check-prod
  cancel-in-progress: true

jobs:
  check-links:
    name: Check Production Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install lychee
        uses: lycheeverse/lychee-action@v2
        with:
          # ì„¤ì¹˜ë§Œ í•˜ê³  ì‹¤í–‰ì€ ë³„ë„ë¡œ
          args: --version

      - name: Check Context links
        if: ${{ github.event.inputs.urls == '' || contains(github.event.inputs.urls, 'context') }}
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --config .lychee.toml
            --verbose
            --no-progress
            https://context.soundbluemusic.com
          fail: true
        continue-on-error: true
        id: context

      - name: Check Permissive links
        if: ${{ github.event.inputs.urls == '' || contains(github.event.inputs.urls, 'permissive') }}
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --config .lychee.toml
            --verbose
            --no-progress
            https://permissive.soundbluemusic.com
          fail: true
        continue-on-error: true
        id: permissive

      - name: Check Roots links
        if: ${{ github.event.inputs.urls == '' || contains(github.event.inputs.urls, 'roots') }}
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --config .lychee.toml
            --verbose
            --no-progress
            https://roots.soundbluemusic.com
          fail: true
        continue-on-error: true
        id: roots

      - name: Summary
        run: |
          echo "## ğŸ”— í”„ë¡œë•ì…˜ ë§í¬ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Context | ${{ steps.context.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Permissive | ${{ steps.permissive.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Roots | ${{ steps.roots.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check results
        run: |
          if [[ "${{ steps.context.outcome }}" == "failure" ]] || \
             [[ "${{ steps.permissive.outcome }}" == "failure" ]] || \
             [[ "${{ steps.roots.outcome }}" == "failure" ]]; then
            echo "âŒ ì¼ë¶€ ì•±ì—ì„œ ê¹¨ì§„ ë§í¬ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "âœ… ëª¨ë“  ì•±ì˜ ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
