name: Deploy Context to Cloudflare

on:
  push:
    branches: [main]
    paths:
      - 'apps/context/**'
      - 'packages/**'
      - 'data/context/**'
  workflow_dispatch: # 수동 트리거 가능

jobs:
  deploy:
    name: Build & Deploy Context
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      # 1. Pages 빌드 (핵심 페이지만 - 241개 파일)
      - name: Build for Pages
        run: pnpm build:context

      # 2. Cloudflare Pages 배포 (프로젝트 없으면 자동 생성)
      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler pages deploy apps/context/build/client --project-name=c0ntext --branch=main

      # 3. rclone 설치 (R2 S3 API로 빠른 업로드)
      - name: Install rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          sudo cp rclone-*-linux-amd64/rclone /usr/local/bin/
          rclone version

      # 3.5. rclone 캐시 복원 (R2 파일 목록 비교 시간 단축)
      - name: Restore rclone cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/rclone
          key: rclone-r2-${{ runner.os }}
          restore-keys: |
            rclone-r2-

      # 4. rclone 설정 (R2 S3 호환 API 사용)
      - name: Configure rclone for R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2_ACCESS_KEY_ID}
          secret_access_key = ${R2_SECRET_ACCESS_KEY}
          endpoint = https://${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com
          acl = private
          EOF

      # 5. R2에 데이터 파일 업로드 (rclone sync - 변경분만 업로드)
      - name: Upload data files to R2
        run: |
          mkdir -p ~/.cache/rclone
          rclone sync apps/context/public/data r2:all-sites-static/public-monorepo/context/data \
            --transfers=32 \
            --checkers=16 \
            --fast-list \
            --progress \
            --stats=10s \
            --cache-dir ~/.cache/rclone

      # 6. R2용 엔트리 HTML 빌드
      - name: Build entries for R2
        run: |
          cd apps/context
          pnpm build:r2

      # 7. R2에 엔트리 HTML 업로드 (rclone sync)
      - name: Upload entry HTML to R2
        run: |
          rclone sync apps/context/build/client r2:all-sites-static/public-monorepo/context \
            --transfers=32 \
            --checkers=16 \
            --fast-list \
            --progress \
            --stats=10s \
            --cache-dir ~/.cache/rclone
