---
/**
 * Custom language selector for Starlight
 * Displays languages as horizontal buttons instead of dropdown
 */
import context from 'virtual:starlight/project-context';
import config from 'virtual:starlight/user-config';

const { locale: currentLocale = '' } = Astro.locals.starlightRoute;
const locales = Object.entries(config.locales ?? {});

/**
 * Get the equivalent of the current page path for the passed locale.
 * Based on Starlight's internal localizedUrl utility
 */
function localizedPathname(targetLocale: string | undefined): string {
  const url = new URL(Astro.url);

  if (!config.locales) return url.pathname;

  // Normalize 'root' to empty string
  if (targetLocale === 'root') targetLocale = '';

  const base = import.meta.env.BASE_URL.replace(/\/$/, '');
  const hasBase = url.pathname.startsWith(base);

  // Temporarily remove base
  if (hasBase) url.pathname = url.pathname.replace(base, '');

  const [_leadingSlash, baseSegment] = url.pathname.split('/');

  // Check if baseSegment is a locale
  if (baseSegment && baseSegment in config.locales) {
    // We're in a localized route, substitute the new locale
    if (targetLocale) {
      url.pathname = url.pathname.replace(baseSegment, targetLocale);
    } else {
      // Strip locale for root lang
      url.pathname = url.pathname.replace('/' + baseSegment, '');
    }
  } else if (targetLocale) {
    // We're in root language, inject the new locale
    url.pathname = '/' + targetLocale + url.pathname;
  }

  // Restore base
  if (hasBase) url.pathname = base + url.pathname;

  // Handle trailing slash based on project config
  if (context.trailingSlash === 'never') {
    url.pathname = url.pathname.replace(/\/$/, '') || '/';
  }

  return url.pathname;
}
---

{config.isMultilingual && (
  <nav class="language-nav" aria-label="Language">
    {locales.map(([code, localeConfig]) => {
      const isCurrent = code === currentLocale || (code === 'root' && currentLocale === '');
      const href = localizedPathname(code);
      return (
        <a
          href={href}
          class:list={['language-link', { current: isCurrent }]}
          aria-current={isCurrent ? 'page' : undefined}
        >
          {localeConfig!.label}
        </a>
      );
    })}
  </nav>
)}

<style>
  .language-nav {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .language-link {
    padding: 0.25rem 0.5rem;
    font-size: 0.8125rem;
    color: var(--sl-color-gray-2);
    text-decoration: none;
    border-radius: 0.25rem;
    transition: color 0.2s, background-color 0.2s;
  }

  .language-link:hover {
    color: var(--sl-color-white);
    background: var(--sl-color-gray-5);
  }

  .language-link.current {
    color: var(--sl-color-accent);
    font-weight: 600;
  }

  /* Separator between links */
  .language-link:not(:last-child)::after {
    content: '|';
    margin-left: 0.5rem;
    color: var(--sl-color-gray-4);
    pointer-events: none;
  }

  /* Mobile responsive */
  @media (max-width: 30rem) {
    .language-link {
      padding: 0.125rem 0.375rem;
      font-size: 0.75rem;
    }
  }
</style>
