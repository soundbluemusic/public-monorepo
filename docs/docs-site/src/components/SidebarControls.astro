---
/**
 * SidebarControls.astro
 * - Resizable sidebar width
 * - Toggle sidebar open/close
 */
---

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle-btn" id="sidebar-toggle" aria-label="Toggle sidebar">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="15 18 9 12 15 6"></polyline>
  </svg>
</button>

<script>
  // Sidebar Toggle
  const toggleBtn = document.getElementById('sidebar-toggle');
  const STORAGE_KEY = 'sb-sidebar-collapsed';

  function initSidebar() {
    const isCollapsed = localStorage.getItem(STORAGE_KEY) === 'true';
    if (isCollapsed) {
      document.documentElement.setAttribute('data-sidebar-collapsed', 'true');
    }
  }

  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      const isCollapsed = document.documentElement.getAttribute('data-sidebar-collapsed') === 'true';
      document.documentElement.setAttribute('data-sidebar-collapsed', String(!isCollapsed));
      localStorage.setItem(STORAGE_KEY, String(!isCollapsed));
    });
  }

  // Resizable Sidebar
  const SIDEBAR_WIDTH_KEY = 'sb-sidebar-width';

  function initResizer() {
    const sidebar = document.querySelector('.sidebar-pane') as HTMLElement;
    if (!sidebar || window.innerWidth < 1152) return;

    // Restore saved width
    const savedWidth = localStorage.getItem(SIDEBAR_WIDTH_KEY);
    if (savedWidth) {
      document.documentElement.style.setProperty('--sb-sidebar-width', savedWidth);
    }

    // Create resize handle
    let resizeHandle = sidebar.querySelector('.sidebar-resize-handle');
    if (!resizeHandle) {
      resizeHandle = document.createElement('div');
      resizeHandle.className = 'sidebar-resize-handle';
      sidebar.appendChild(resizeHandle);
    }

    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    resizeHandle.addEventListener('mousedown', (e: Event) => {
      const event = e as MouseEvent;
      isResizing = true;
      startX = event.clientX;
      startWidth = sidebar.offsetWidth;
      resizeHandle.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e: MouseEvent) => {
      if (!isResizing) return;
      const diff = e.clientX - startX;
      const newWidth = Math.min(Math.max(startWidth + diff, 200), 400);
      document.documentElement.style.setProperty('--sb-sidebar-width', `${newWidth}px`);
    });

    document.addEventListener('mouseup', () => {
      if (!isResizing) return;
      isResizing = false;
      resizeHandle.classList.remove('dragging');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      const currentWidth = getComputedStyle(document.documentElement).getPropertyValue('--sb-sidebar-width');
      localStorage.setItem(SIDEBAR_WIDTH_KEY, currentWidth);
    });
  }

  // Initialize
  initSidebar();

  // Wait for DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initResizer);
  } else {
    initResizer();
  }

  // Re-init on page navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', () => {
    initSidebar();
    initResizer();
  });
</script>
