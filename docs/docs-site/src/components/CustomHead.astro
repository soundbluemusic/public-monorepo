---
/**
 * Custom Head component for Starlight
 * Adds BreadcrumbList and TechArticle JSON-LD structured data
 */
import type { StarlightRouteData } from '@astrojs/starlight/route-data';
import Default from '@astrojs/starlight/components/Head.astro';

// Starlight 0.36+ uses Astro.locals.starlightRoute instead of Astro.props
const route = Astro.locals.starlightRoute as StarlightRouteData;
const { entry, slug, lang } = route;

// Base URL
const baseUrl = 'https://soundbluemusic.github.io/public-monorepo';

// Build breadcrumb items from slug
function buildBreadcrumbs(slug: string, lang: string) {
  const langPrefix = lang === 'en' ? '' : `/${lang}`;
  const homeLabel = lang === 'ko' ? '홈' : lang === 'ja' ? 'ホーム' : 'Home';

  const items = [
    { name: homeLabel, url: `${baseUrl}${langPrefix}/` }
  ];

  if (!slug || slug === '') return items;

  const parts = slug.split('/').filter(Boolean);
  let currentPath = '';

  // Section labels mapping
  const sectionLabels: Record<string, Record<string, string>> = {
    guides: { en: 'Guides', ko: '가이드', ja: 'ガイド' },
    apps: { en: 'Apps', ko: '앱', ja: 'アプリ' },
    packages: { en: 'Packages', ko: '패키지', ja: 'パッケージ' },
    contributing: { en: 'Contributing', ko: '기여', ja: '貢献' },
    'ai-guidelines': { en: 'AI Guidelines', ko: 'AI 가이드', ja: 'AI ガイド' },
    reference: { en: 'Reference', ko: '참조', ja: 'リファレンス' },
    context: { en: 'Context', ko: 'Context', ja: 'Context' },
    permissive: { en: 'Permissive', ko: 'Permissive', ja: 'Permissive' },
    roots: { en: 'Roots', ko: 'Roots', ja: 'Roots' },
  };

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i];
    currentPath += `/${part}`;

    // Skip language prefix in path
    if (i === 0 && (part === 'ko' || part === 'ja')) continue;

    const label = sectionLabels[part]?.[lang] || part.charAt(0).toUpperCase() + part.slice(1).replace(/-/g, ' ');

    // Last item is current page - use entry title
    if (i === parts.length - 1 && entry?.data?.title) {
      items.push({ name: entry.data.title, url: `${baseUrl}${langPrefix}${currentPath}/` });
    } else {
      items.push({ name: label, url: `${baseUrl}${langPrefix}${currentPath}/` });
    }
  }

  return items;
}

// Build BreadcrumbList JSON-LD
const breadcrumbs = buildBreadcrumbs(slug || '', lang || 'en');
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbs.map((item, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: item.name,
    item: item.url,
  })),
};

// Build TechArticle JSON-LD for documentation pages
const title = entry.data.title;
const description = entry.data.description || 'Documentation for SoundBlue applications';
const articleLangPrefix = lang === 'en' ? '' : `/${lang}`;
const pageSlug = slug || '';
const pageUrl = pageSlug
  ? `${baseUrl}${articleLangPrefix}/${pageSlug}/`
  : `${baseUrl}${articleLangPrefix}/`;

const techArticleSchema = {
  '@context': 'https://schema.org',
  '@type': 'TechArticle',
  headline: title,
  description: description,
  url: pageUrl,
  inLanguage: lang || 'en',
  author: {
    '@type': 'Organization',
    name: 'SoundBlue Music',
    url: 'https://soundbluemusic.com',
  },
  publisher: {
    '@type': 'Organization',
    name: 'SoundBlue Music',
    url: 'https://soundbluemusic.com',
  },
  proficiencyLevel: 'Beginner',
};
---

<Default {...Astro.props}>
  <slot />
</Default>

<!-- BreadcrumbList JSON-LD -->
<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

<!-- TechArticle JSON-LD -->
<script type="application/ld+json" set:html={JSON.stringify(techArticleSchema)} />
